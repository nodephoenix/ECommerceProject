<!-- ì£¼ë¬¸ìƒì„¸ì¡°íšŒ í˜ì´ì§€ -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <!-- JavaScript Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>

    <!-- JQuery import -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <!-- CSS -->
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      html,
      body {
        width: 100%;
        height: 100%;
      }
      body {
        /* background-image: url("https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbdByfl%2FbtrVf7i5Uq5%2FjJ5afu7vrUKkgNGmzP2kAk%2Fimg.jpg"); */
        background-image: linear-gradient(
          109.6deg,
          rgba(156, 252, 248, 1) 11.2%,
          rgba(110, 123, 251, 1) 91.1%
        );
        /* background-image: radial-gradient(circle farthest-corner at 52.1% -29.6%, rgba(144, 17, 105, 1) 0%, rgba(51, 0, 131, 1) 100.2%); */
        /* background: linear-gradient(to right, rgb(242, 112, 156), rgb(255, 148, 114)); */
        background-repeat: no-repeat;
        background-size: cover;
      }
      .flex_center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }
      .main {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }

      .top-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 23%;
      }
      .input-bar {
        padding-top: 100px;
        font-weight: bold;
      }
      .input-content {
        display: block;
        margin: auto;
        width: 300px;
        height: 30%;
      }
      .product-img {
        width: 125px;
        height: 125px;
      }
      .detail {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 23%;
      }
      .inline-block {
        display: inline-block;
      }
      .order-history {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }
      .bottom-text {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 3rem;
        color: #0a174e;
      }
      .card {
        font-weight: bold;
      }
      .payment {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 30px;
        color: #0a174e;
        font-weight: bold;
        font-size: 30px;
      }
    </style>
    <script>
      $(document).ready(function () {
        getCarts();
      });
      
      function getCarts() {
        let sum = 0

        $.ajax({
          method: "GET",
          url: "/api/carts",
          data: {},
          success: function (response) {
            let cartData = response.data.carts;
            for (let i = 0; i < cartData.length; i++) {
              let productName = cartData[i]["productName"];
              let price = cartData[i]["price"];
              let image = cartData[i]["image"];
              let count = cartData[i]["Cart"]["count"];
              let productId = cartData[i]["Cart"]["product_id"];
              let cartDate = cartData[i]["Cart"]["updatedAt"];
              let sumPrice = price * count
              sum = sum + sumPrice
              let temp_html = `      <table style="margin: 20px auto 0 auto">
        <tr>
          <td style="width: 150px">
            <img
              src=${image}
              class="img-thumbnail product-img"
              alt="..."
            />
          </td>
          <td style="width: 300px">
            <div class="card" style="width: 18rem">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">ìƒí’ˆëª…: ${productName}</li>
                <li class="list-group-item">ê°€ê²©: ${sumPrice}ì›</li>
                <li class="list-group-item">ë‹´ì€ ì¼ì: ${cartDate}</li>
                <li class="list-group-item">
                  ìˆ˜ëŸ‰:
                  <button
                    type="button"
                    class="btn btn-outline-success"
                    id="minus" onclick="minus(${productId})"
                  >
                    -
                  </button>
                  <span id="${productId}count">${count}</span>
                  <button
                    type="button"
                    class="btn btn-outline-success"
                    id="plus" onclick="plus(${productId})"
                  >
                    +
                  </button>
                  <button
                    type="button"
                    class="btn btn-danger"
                    style="margin-left: 35px"
                    onclick="editCount(${productId})"
                  >
                    ìˆ˜ì •
                  </button>
                  <button
                    type="button"
                    class="btn btn-danger"
                    style="margin-left: 35px"
                    onclick="deleteItem(${productId})"
                  >
                    ì‚­ì œ
                  </button>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      </table>
      `;
              $("#cart-list").append(temp_html);
            }
            document.getElementById('sumPrice').innerHTML = `${sum} ì›`
          },
          error: function (error) {
            if(error.status === 401){
              alert(error.responseJSON.errorMessage)
              return window.location.replace('/login')
            }
            alert(error.responseJSON.errorMessage)
          },
        });
      }

      // ìˆ˜ëŸ‰ ì¦ê°€ì‹œí‚¤ê¸°
      function plus(productId) {
        let count = document.getElementById(`${productId}count`).innerText;
        return (document.getElementById(`${productId}count`).innerText = Number(count) + 1);
      }

      // ìˆ˜ëŸ‰ ê°ì†Œì‹œí‚¤ê¸°
      function minus(productId) {
        let count = document.getElementById(`${productId}count`).innerText;
        if (count <= 1) {
          return count;
        }
        return (document.getElementById(`${productId}count`).innerText = Number(count) - 1);
      }

      // ìˆ˜ëŸ‰ ìˆ˜ì •í•˜ê¸°
      function editCount(productId) {
        let count = Number(document.getElementById(`${productId}count`).innerText);

        $.ajax({
          type: "PUT",
          url: `/api/carts/${productId}`,
          data: { productId: productId, count: count },
          success: function (response) {
            alert("ë‹´ì€ ìˆ˜ëŸ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.reload();
          },
        });
      }

      // ë‹¨ì¼ ìƒí’ˆ ì‚­ì œí•˜ê¸°
      function deleteItem(productId) {
        const check = confirm("ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if(!check) {
          return window.location.reload();
        }

        $.ajax({
          type: "delete",
          url: `/api/carts/${productId}`,
          data: { productId: productId },
          success: function (response) {
            alert("ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); 
          },
        });
      }

      // ì „ì²´ ìƒí’ˆ êµ¬ë§¤í•˜ê¸°
      function orderCart() {
        const check = confirm("ì „ì²´ ìƒí’ˆì„ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if(!check){
          return window.location.reload();
        }
        
        $.ajax({
          type: "POST",
          url: `/api/orders/carts`,
          data: {},
          success: function (response) {
            alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.reload();
          },
        });
      }

      // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
      function deleteAllItems() {
        $.ajax({
          type: "DELETE",
          url: `/api/carts`,
          data: {},
          success: function (response) {
            confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?");
            alert("ì¥ë°”êµ¬ë‹ˆ ì „ì²´ ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.reload();
          },
        });
      }

    </script>
    <title>ğŸ–¼ì¥ë°”êµ¬ë‹ˆğŸ¨</title>
  </head>
  <body>
    <% if(admin) { %>
      <%- include('adminlogoutheader.ejs') %> 
      <% } else if(login) { %> 
      <%- include('logoutheader.ejs') %>
      <% } else { %>
      <%-include('loginheader.ejs') %> <% } %>
    <!-- íƒ‘ë°” -->
    <div class="top-bar">
      <h1 style="color: #0a174e; font-weight: bold">ğŸ–¼ì¥ë°”êµ¬ë‹ˆğŸ¨</h1>
    </div>
    <nav class="order-history">
      <div style="font-weight: bold">ì¥ë°”êµ¬ë‹ˆ ëª©ë¡</div>
    </nav>
    <hr />
    <!-- ìƒí’ˆí‘œì‹œí™”ë©´ -->
    <div id="cart-list"></div>
    <!-- ìƒí’ˆê¸ˆì•¡ --> 
    <div class="payment">
      <p id="sumPrice">ì´ ê²°ì œê¸ˆì•¡: 0ì›</p>
    </div>
    <!-- í•˜ë‹¨ ë²„íŠ¼ë°” -->
    <nav class="bottom-text" style="margin-top: 20px">
      <span id="order">
        <button
          type="button"
          class="btn btn-success"
          style="font-weight: bold"
          onclick="orderCart()"
        >
          êµ¬ë§¤í•˜ê¸°
        </button>
      </span>
      <span id="deleteAllItems">
        <button
        type="button"
        class="btn btn-danger"
        style="margin-left: 20px; font-weight: bold"
        onclick="deleteAllItems()"
        >
        ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
        </button>
      </span>
    </nav>     
    </nav>
    <script>
      // ì¥ë°”êµ¬ë‹ˆ ì „ì²´ ì‚­ì œ
    </script>
  </body>
</html>

